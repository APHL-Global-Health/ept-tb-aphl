<?php
$attributes = json_decode($this->evaluateData['shipment']['attributes'],true);
$dateFormatHelper = $this->getHelper('DateFormat');
$dtFormat=  $dateFormatHelper->getDateFormat();
?>
	<table class="table table-bordered table-striped" style="width:100%;margin:0 auto 10px auto;">
		<tr>
			<th style="width:20%;"><label>Shipment Code</label></th>
			<td style="width:30%;"><?php echo $this->evaluateData['shipment']['shipment_code']; ?></td>
			<th style="width:20%;"><label>Scheme Type</th>
			<td style="width:30%;"><?php echo strtoupper($this->evaluateData['shipment']['scheme_type']); ?></td>
		</tr>
		<tr>
			<th><label>Shipment Date</label></th>
			<td><?php echo $this->dateFormat($this->evaluateData['shipment']['shipment_date']); ?></td>
			<th><label>Result Due Date</th>
			<td><?php echo $this->dateFormat($this->evaluateData['shipment']['lastdate_response']); ?></td>
		</tr>
        <tr>
            <th><label>Shipment Received on</label></th>
            <td>
                <input type="text" id="receiptDate" name="receiptDate" size="11" maxlength="11" style="width:180px;float:left;" value="<?php echo $this->dateFormat($this->evaluateData['shipment']["shipment_receipt_date"]); ?>" class="form-control datepicker" readonly="readonly"   title="Please enter Test Receipt Date" />
                <i class="icon-remove-sign" style="cursor:pointer;margin-top:10px;margin-left:10px;float:left;" alt="Clear Date" title="Clear Date"  onclick="clearDate('receiptDate')"> Clear</i>
            </td>
            <td><label>Sample Rehydration Date <span class="mandatory">*</span></label></td>
            <td>
                <input type="text" name="sampleRehydrationDate" id="sampleRehydrationDate"  style="width:180px;float:left;" value="<?php  echo  $this->dateFormat($attributes["sample_rehydration_date"]); ?>" class="isRequired datepicker form-control" readonly="readonly" />
                <i class="icon-remove-sign" style="cursor:pointer;margin-top:10px;margin-left:10px;float:left;" alt="Clear Date" title="Clear Date"  onclick="clearDate('sampleRehydrationDate')"> Clear</i>
            </td>
        </tr>
        <tr>
            <th><label>Samples Tested on <span class="mandatory">*</span></label></th>
            <td>
                <input type="text" id="testDate" name="testDate" style="width:180px;float:left;" maxlength="11" value="<?php  echo  $this->dateFormat($this->evaluateData['shipment']["shipment_test_date"]); ?>"  class="isRequired datepicker form-control" readonly="readonly" />
                <i class="icon-remove-sign" style="cursor:pointer;margin-top:10px;margin-left:10px;float:left;" alt="Clear Date" title="Clear Date"  onclick="clearDate('testDate')"> Clear</i>
            </td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <th><label>MTB/RIF Kit Lot No</label></th>
            <td>
                <input type="text" name="mtbRifKitLotNo" id="mtbRifKitLotNo" class="form-control isRequired" value="<?php echo $attributes['mtb_rif_kit_lot_no'];?>"/>
            </td>
            <td><label>Expiry Date:</label></td>
            <td>
                <input type="text" name="expiryDate" id="expiryDate" style="width:180px;float:left;" maxlength="11" value="<?php echo $attributes['expiry_date'];?>" class="isRequired datepicker form-control" readonly="readonly"/>
                <i class="icon-remove-sign" style="cursor:pointer;margin-top:10px;margin-left:10px;float:left;" alt="Clear Date" title="Clear Date"  onclick="clearDate('expiryDate')"> Clear</i>
            </td>
        </tr>
        <tr>
            <td><label>Assay</label></td>
            <td>
                <select class="form-control" name="assay" id="assay" class="form-control" title="Please choose the assay type">
                    <?php
                    foreach($this->assays as $id => $name) {
                        ?>
                        <option value="<?php echo $id; ?>" <?php if(isset($attributes['assay'])) { echo ($attributes['assay'] == $id) ? "selected='selected'" : ""; } ?>><?php echo $name; ?></option>
                        <?php
                    }
                    ?>
                </select>
            </td>
            <td><label>How many Xpert MTB/RIF tests have been conducted by this site in the last full month?</label></td>
            <td>
                <input type="text" name="countTestsConductedOverMonth" id="countTestsConductedOverMonth" class="form-control" value="<?php if(isset($attributes['count_tests_conducted_over_month'])) { echo $attributes['count_tests_conducted_over_month']; }?>"/>
            </td>
        </tr>
        <tr>
            <td><label>How many errors occurred during testing in the last full month?</label></td>
            <td>
                <input type="text" name="countErrorsEncounteredOverMonth" id="countErrorsEncounteredOverMonth" class="form-control"  value="<?php if(isset($attributes['count_errors_encountered_over_month'])) { echo $attributes['count_errors_encountered_over_month']; }?>"/>
            </td>
            <td><label>What were the error codes?</label></td>
            <td>
                <input type="text" name="errorCodesEncounteredOverMonth" id="errorCodesEncounteredOverMonth" class="form-control" value="<?php if(isset($attributes['error_codes_encountered_over_month'])) { echo $attributes['error_codes_encountered_over_month']; }?>"/>
            </td>
        </tr>
        <tr>
             <th>Supervisor Review</th>
            <td>
                <select name="supervisorApproval" id="supervisorApproval" class="isRequired form-control"  title="Please select if Supervisor Approval was conducted or not">
                    <option value=""> -- Select -- </option>
                    <option value="yes" <?php if (strtolower($this->evaluateData['shipment']['supervisor_approval']) == 'yes') echo " selected "; ?>>YES</option>
                    <option value="no" <?php if (strtolower($this->evaluateData['shipment']['supervisor_approval']) == 'no') echo " selected "; ?>>NO</option>
                </select>
            </td>
            <th  id ="labSupervisor" <?php echo(isset($this->evaluateData['shipment']['supervisor_approval']) && strtolower($this->evaluateData['shipment']['supervisor_approval']) == 'yes') ? "" : "style='display:none;'" ?> >Supervisor Name</th>
            <td>
                <input name="participantSupervisor" id="participantSupervisor" type="text" <?php echo(isset($this->evaluateData['shipment']['supervisor_approval']) && strtolower($this->evaluateData['shipment']['supervisor_approval']) == 'yes') ? "" : "style='display:none;'" ?>  class="form-control" value="<?php echo $this->evaluateData['shipment']['participant_supervisor']; ?>"/>
            </td>
        </tr>
        <tr>
            <th>User Comments</th>
            <td colspan="3"><textarea class="form-control" name="userComments" id="userComments"><?php echo $this->evaluateData['shipment']['user_comment']; ?></textarea></td>
        </tr>
	</table>
    <br/>
	<table class="table table-bordered table-striped table-hover" style="width:100%;margin:0 auto;">
		<?php
		$total = 0;
		$counter = 1;
		foreach($this->evaluateData['results'] as $result){
			if(($counter%2) == 0){
				$class = "evenResult";
			} else {
				$class = "oddResult";
			}
            $errorCodeEnabled = $result['res_mtb_detected'] == "invalid";
            $rifResistanceEnabled = in_array($result['res_mtb_detected'], array("high", "medium", "low", "veryLow"));
			?>
			<tr class="<?php echo $class ?>">
                <td>
                    <table class="table" style="background-color: transparent;">
                        <tr>
                            <th colspan="11" style="white-space: nowrap;background-color: transparent;">
                                <?php echo $result['sample_label']; ?>
                                <input type="hidden" id ="sample<?php echo $counter; ?>" name="sampleId[]" value="<?php echo $result['sample_id'];?>" />
                            </th>
                        </tr>
                        <tr style="background-color: transparent;">
                            <th style="background-color: transparent;">Date Tested</th>
                            <th style="background-color: transparent;">MTB Detected</th>
                            <th style="background-color: transparent;">Error Code</th>
                            <th style="background-color: transparent;">Rif Resistance</th>
                            <th style="background-color: transparent;">Probe D</th>
                            <th style="background-color: transparent;">Probe C</th>
                            <th style="background-color: transparent;">Probe E</th>
                            <th style="background-color: transparent;">Probe B</th>
                            <th style="background-color: transparent;">SPC</th>
                            <th style="background-color: transparent;">Probe A</th>
                            <th style="text-align: center;font-size:17px;">Acceptable?</th>
                        </tr>
                        <tr>
                            <td style="vertical-align: middle;text-align: center;width: 14%;background-color: transparent;">
                                <input type="text" class="form-control datepicker sampleTestDate input-sm" readonly="readonly" name="dateTested[]" value="<?php echo $this->dateFormat($result['res_date_tested']); ?>" title="Please enter the Test Date for <?php echo $result['sample_label']; ?>" />
                            </td>
                            <td style="vertical-align: middle;text-align: center;width: 13%;background-color: transparent;">
                                <select id="mtbDetected<?php echo $counter; ?>" name="mtbDetected[]" class="isRequired form-control input-sm"  title="Please enter the MTB Detected for this sample" placeholder="Please enter the MTB Detected for this sample" onChange="changeMtbDetected(<?php echo $counter; ?>)">
                                    <option value="">Unknown</option>
                                    <option value="high" <?php echo ($result['res_mtb_detected'] == 'high' ? "selected='selected'" : ""); ?>>High</option>
                                    <option value="medium" <?php echo ($result['res_mtb_detected'] == 'medium' ? "selected='selected'" : ""); ?>>Medium</option>
                                    <option value="low" <?php echo ($result['res_mtb_detected'] == 'low' ? "selected='selected'" : ""); ?>>Low</option>
                                    <option value="veryLow" <?php echo ($result['res_mtb_detected'] == 'veryLow' ? "selected='selected'" : ""); ?>>Very Low</option>
                                    <option value="notDetected" <?php echo ($result['res_mtb_detected'] == 'notDetected' ? "selected='selected'" : ""); ?>>Not Detected</option>
                                    <option value="noResult" <?php echo ($result['res_mtb_detected'] == 'noResult' ? "selected='selected'" : ""); ?>>No Result</option>
                                    <option value="invalid" <?php echo ($result['res_mtb_detected'] == 'invalid' ? "selected='selected'" : ""); ?>>Invalid</option>
                                </select>
                            </td>
                            <td style="vertical-align: middle;text-align: center;width: 11%;">
                                <input type="text" id="errorCode<?php echo $counter; ?>" name="errorCode[]" class="form-control input-sm" value="<?php echo $result['res_error_code']; ?>" title="Please enter the Probe D value for <?php echo $result['sample_label']; ?>"  <?php if (!$errorCodeEnabled) { echo "disabled"; } ?> />
                            </td>
                            <td style="vertical-align: middle;text-align:center;width: 13%;">
                                <select id="rifResistance<?php echo $counter; ?>" name="rifResistance[]" class="isRequired form-control input-sm"  title="Please enter the Rif Resistance for this sample" placeholder="Please enter the Rif Resistance for this sample" <?php if (!$rifResistanceEnabled) { echo "disabled"; } ?> >
                                    <option value="">-- Select --</option>
                                    <option value="detected" <?php echo ($result['res_rif_resistance'] == 'detected' ? "selected='selected'" : ""); ?>>Detected</option>
                                    <option value="notDetected"  <?php echo ($result['res_rif_resistance'] == 'notDetected' ? "selected='selected'" : ""); ?>>Not Detected</option>
                                    <option value="na"  <?php echo ($result['res_rif_resistance'] == 'na' ? "selected='selected'" : ""); ?>>N/A</option>
                                </select>
                            </td>
                            <td style="vertical-align: middle;text-align: center;width: 7%;">
                                <input type="text" name="probeD[]" class="form-control oneDecimal input-sm numberInput" value="<?php echo $result['res_probe_d']; ?>" title="Please enter the Probe D value for <?php echo $result['sample_label']; ?>" />
                            </td>
                            <td style="vertical-align: middle;text-align: center;width: 7%;">
                                <input type="text" name="probeC[]" class="form-control oneDecimal input-sm numberInput" value="<?php echo $result['res_probe_c']; ?>" title="Please enter the Probe C value for <?php echo $result['sample_label']; ?>" />
                            </td>
                            <td style="vertical-align: middle;text-align: center;width: 7%;">
                                <input type="text" name="probeE[]" class="form-control oneDecimal input-sm numberInput" value="<?php echo $result['res_probe_e']; ?>" title="Please enter the Probe E value for <?php echo $result['sample_label']; ?>" />
                            </td>
                            <td style="vertical-align: middle;text-align: center;width: 7%;">
                                <input type="text" name="probeB[]" class="form-control oneDecimal input-sm numberInput" value="<?php echo $result['res_probe_b']; ?>" title="Please enter the Probe B value for <?php echo $result['sample_label']; ?>" />
                            </td>
                            <td style="vertical-align: middle;text-align: center;width: 7%;">
                                <input type="text" name="spc[]" class="form-control oneDecimal input-sm numberInput" value="<?php echo $result['res_spc']; ?>" title="Please enter the SPC value for <?php echo $result['sample_label']; ?>" />
                            </td>
                            <td style="vertical-align: middle;text-align: center;width: 7%;">
                                <input type="text" name="probeA[]" class="form-control oneDecimal input-sm numberInput" value="<?php echo $result['res_probe_a']; ?>" title="Please enter the Probe A value for <?php echo $result['sample_label']; ?>" />
                            </td>
                            <td rowspan="2" style="vertical-align: middle;text-align: center;width: 7%;font-weight: bold;">
                                <?php
                                if(isset($result['res_mtb_detected']) && isset($result['res_rif_resistance'])){
                                    if($result['res_mtb_detected'] == $result['ref_mtb_detected'] &&
                                        $result['res_rif_resistance'] == $result['ref_rif_resistance']){
                                        echo "Yes";
                                    }else{
                                        echo "No";
                                    }

                                }else{
                                    echo "N/A";
                                }
                                ?>
                            </td>
                        </tr>
                        <tr>
                            <td style="vertical-align: middle;text-align: right;">Reference Values:</td>
                            <td style="vertical-align: middle;text-align: center;">
                                <?php
                                switch ($result['ref_mtb_detected']) {
                                    case "high":
                                        echo "High";
                                        break;
                                    case "medium":
                                        echo "Medium";
                                        break;
                                    case "low":
                                        echo "Low";
                                        break;
                                    case "veryLow":
                                        echo "Very Low";
                                        break;
                                    case "notDetected":
                                        echo "Not Detected";
                                        break;
                                    case "noResult":
                                        echo "No Result";
                                        break;
                                    case "invalid":
                                        echo "Invalid";
                                        break;
                                    default:
                                        echo "Unknown";
                                }
                                ?>
                            </td>
                            <td></td>
                            <td style="vertical-align: middle;text-align:center;">
                                <?php
                                switch ($result['ref_rif_resistance']) {
                                    case "detected":
                                        echo "Detected";
                                        break;
                                    case "notDetected":
                                        echo "Not Detected";
                                        break;
                                    case "na":
                                        echo "N/A";
                                        break;
                                    default:
                                        echo "Unknown";
                                }
                                ?>
                            </td>
                            <td style="vertical-align: middle;text-align: right;">
                                <?php
                                echo $result['ref_probe_d'];
                                ?>
                            </td>
                            <td style="vertical-align: middle;text-align: right;">
                                <?php
                                echo $result['ref_probe_c'];
                                ?>
                            </td>
                            <td style="vertical-align: middle;text-align: right;">
                                <?php
                                echo $result['ref_probe_e'];
                                ?>
                            </td>
                            <td style="vertical-align: middle;text-align: right;">
                                <?php
                                echo $result['ref_probe_b'];
                                ?>
                            </td>
                            <td style="vertical-align: middle;text-align: right;">
                                <?php
                                echo $result['ref_spc'];
                                ?>
                            </td>
                            <td style="vertical-align: middle;text-align: right;">
                                <?php
                                echo $result['ref_probe_a'];
                                ?>
                            </td>
                        </tr>
                        <tr>
                            <th colspan="2" style="vertical-align: bottom;">Serial Number</th>
                            <th style="vertical-align: bottom;">Installed</th>
                            <th style="vertical-align: bottom;">Last Calibrated</th>
                            <th style="vertical-align: bottom;">Module Name</th>
                            <th colspan="2" style="vertical-align: bottom;">Instrument User</th>
                            <th colspan="2" style="vertical-align: bottom;">Cartridge Expires</th>
                            <th colspan="2" style="vertical-align: bottom;">Reagent Lot ID</th>
                        </tr>
                        <tr style="background-color: transparent;">
                            <th colspan="2" style="white-space: nowrap;background-color: transparent;">
                                <input type="text" name="instrumentSerial[]" class="form-control input-sm" value="<?php echo $result['res_instrument_serial']; ?>" title="Please enter the instrument serial number for <?php echo $result['sample_label']; ?>" />
                            </th>
                            <td style="background-color: transparent;">
                                <input type="text" class="form-control datepicker input-sm" readonly="readonly" name="instrumentInstalledOn[]" value="<?php echo $this->dateFormat($result['res_instrument_installed_on']); ?>" title="Please enter the instrument installation date for <?php echo $result['sample_label']; ?>" />
                            </td>
                            <td style="background-color: transparent;">
                                <input type="text" class="form-control datepicker input-sm" readonly="readonly" name="instrumentLastCalibratedOn[]" value="<?php echo $this->dateFormat($result['res_instrument_last_calibrated_on']); ?>" title="Please enter the date that the instrument was last calibrated for <?php echo $result['sample_label']; ?>" />
                            </td>
                            <th style="white-space: nowrap;background-color: transparent;">
                                <input type="text" name="moduleName[]" class="form-control input-sm" value="<?php echo $result['res_module_name']; ?>" title="Please enter the module name for <?php echo $result['sample_label']; ?>" />
                            </th>
                            <th colspan="2" style="white-space: nowrap;background-color: transparent;">
                                <input type="text" name="instrumentUser[]" class="form-control input-sm" value="<?php echo $result['res_instrument_user']; ?>" title="Please enter the instrument user for <?php echo $result['sample_label']; ?>" />
                            </th>
                            <td colspan="2" style="background-color: transparent;">
                                <input type="text" class="form-control datepicker input-sm" readonly="readonly" name="cartridgeExpirationDate[]" value="<?php echo $this->dateFormat($result['res_cartridge_expiration_date']); ?>" title="Please enter the cartridge expiration date for <?php echo $result['sample_label']; ?>" />
                            </td>
                            <th colspan="2" style="white-space: nowrap;background-color: transparent;">
                                <input type="text" name="reagentLotId[]" class="form-control input-sm" value="<?php echo $result['res_reagent_lot_id']; ?>" title="Please enter the reagent lot ID for <?php echo $result['sample_label']; ?>" />
                            </th>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr class="<?php echo $class ?>"></tr>
			<?php
			$counter++;
		}
		?>
</table>
<script>
	$(function() {
  	    $(".datepicker,.expDatepicker").datepicker({dateFormat: '<?php echo $dtFormat; ?>'});
		<?php if(!$this->isEditable){
			?>
			$("#tbResponseForm").find("input:enabled, select:enabled, textarea:enabled").attr("disabled", "disabled");
			<?php
		}
		?>		
	});

	function clearDate(id) {
		$("#" + id).val('');
	}

    function changeMtbDetected(resultNumber) {
        var mtbDetected = $("#mtbDetected" + resultNumber).val();
        var errorCodeInput = $("#errorCode" + resultNumber);
        var rifResistanceSelect = $("#rifResistance" + resultNumber);
        if (mtbDetected === "invalid") {
            errorCodeInput.removeAttr("disabled");
        } else {
            errorCodeInput.attr("disabled", "");
            errorCodeInput.val('')
        }
        if (["high", "medium", "low", "veryLow"].includes(mtbDetected)) {
            rifResistanceSelect.removeAttr("disabled");
        } else {
            rifResistanceSelect.attr("disabled", "");
            rifResistanceSelect.val('na')
        }
    }
</script>