<?php
// Include the main TCPDF library (search for installation path).
require_once('tcpdf/tcpdf.php');
//Zend_Debug::dump($this->result);die;

// create new PDF document
$pdf = new TCPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);

// set document information
$pdf->SetCreator(PDF_CREATOR);
$pdf->SetAuthor('Nicola Asuni');
$pdf->SetTitle('TCPDF Example 003');
$pdf->SetSubject('TCPDF Tutorial');
$pdf->SetKeywords('TCPDF, PDF, example, test, guide');

// set default header data
$pdf->SetHeaderData(PDF_HEADER_LOGO, '45', 'Participant Corrective Action Overview', '');

// set header and footer fonts
$pdf->setHeaderFont(Array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
$pdf->setFooterFont(Array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));

// set default monospaced font
$pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);

// set margins
$pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);
$pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
$pdf->SetFooterMargin(PDF_MARGIN_FOOTER);

// set auto page breaks
$pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);

// set image scale factor
$pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);

// set some language-dependent strings (optional)
if (@file_exists(dirname(__FILE__).'/lang/eng.php')) {
    require_once(dirname(__FILE__).'/lang/eng.php');
    $pdf->setLanguageArray($l);
}

// ---------------------------------------------------------

// set default font subsetting mode
$pdf->setFontSubsetting(true);

// Set font
// dejavusans is a UTF-8 Unicode font, if you only need to
// print standard ASCII chars, you can use core fonts like
// helvetica or times to reduce file size.
//$pdf->SetFont('dejavusans', '', 14, '', true);
$pdf->SetFont('times', '', 12);
// Add a page
// This method has several options, check the source code documentation for more information.
$pdf->AddPage();

if(trim($this->result['countCorrectiveAction']['total_responses'])==""){
    $this->result['countCorrectiveAction']['total_responses']=0;
}
if(trim($this->result['countCorrectiveAction']['valid_responses'])==""){
    $this->result['countCorrectiveAction']['valid_responses']=0;
}

$correctiveAction='';
if(trim($this->shipmentName)!=""){
    $correctiveAction.='<div><span style="font-weight:bold">Shipment : </span> '.$this->shipmentName.'</div>';
}
$correctiveAction.='<div><span style="font-weight:bold">Selected Date Range : </span> '.$this->dateRange.'</div>';


$correctiveAction.='<div><span style="font-weight:bold">Total shipped : </span> '.$this->result['countCorrectiveAction']['total_shipped'].'</div>';
$correctiveAction.='<div><span style="font-weight:bold">Total number of responses : </span>'.$this->result['countCorrectiveAction']['total_responses'].'</div>';
$correctiveAction.='<div><span style="font-weight:bold">Total number of valid responses : </span>'.$this->result['countCorrectiveAction']['valid_responses'].'</div>';
$correctiveAction.='<div><span style="font-weight:bold">Average score : </span>'.round($this->result['countCorrectiveAction']['average_score'], 2) . '%'.'</div>';

// Set some content to print
$correctiveAction.='<br/><table border="1" align="center">';
$correctiveAction.='<tr>';
$correctiveAction.='<td style="font-weight:bold">Corrective Action</td>';
$correctiveAction.='<td style="font-weight:bold">No. of Responses having this corrective action</td>';
$correctiveAction.='</tr>';

if(count($this->result['correctiveAction'])>0){
    foreach($this->result['correctiveAction'] as $res){
        $correctiveAction.='<tr>';
        $correctiveAction.='<td style="text-align:left;">'.$res['corrective_action'].'</td>';
        $correctiveAction.='<td>'.$res['total_corrective'].'</td>';
        $correctiveAction.='</tr>';
    }
}else{
    $correctiveAction.='<tr><td colspan="2">No result found</td></tr>';
}
$correctiveAction.='</table>';
$pdf->writeHTML($correctiveAction, true, false, true, false, '');


// ---------------------------------------------------------

// Close and output PDF document
$fileName = "corrective-action-".date('d-M-Y-H-i-s').".pdf";
$filePath = TEMP_UPLOAD_PATH . DIRECTORY_SEPARATOR.$fileName;
//$pdf->Output('example_003.pdf', 'I');
$pdf->Output($filePath, "F");
echo $fileName;
//============================================================+
// END OF FILE
//============================================================+