<?php

//Zend_Debug::dump($this->result);die;

require_once('tcpdf/tcpdf.php');
$schemeType = $this->result[0]['scheme_type'];
if(sizeof($this->result)>0){
	if (!file_exists(UPLOAD_PATH . DIRECTORY_SEPARATOR . 'reports') && !is_dir(UPLOAD_PATH . DIRECTORY_SEPARATOR . 'reports')) {
		mkdir(UPLOAD_PATH . DIRECTORY_SEPARATOR . 'reports');
        }	
class MYPDF extends TCPDF {
	public $scheme_name = '';

	public function setSchemeName($schemeName) {
		$this->scheme_name = $schemeName;
	}
    
    //Page header
    public function Header() {
        // Logo
        $image_file = K_PATH_IMAGES.'logo_example.jpg';
	
        $this->Image($image_file, 10, 10, 15, '', 'JPG', '', 'T', false, 300, '', false, false, 0, false, false, false);
        // Set font
        $this->SetFont('times', 'B', 10);
        // Title
        $this->Cell(0, 15, 'DEPARTMENT OF HEALTH AND HUMAN SERVICES', 0, false, 'C', 0, '', 0, false, 'M', 'M');
	
	
	$this->SetFont('times', '', 12);
        
	$html='<table><tr><td style="text-align:center;">International Laboratory Branch</td></tr><tr><td style="text-align:center;">Division of Global HIV/AIDS, CDC-Atlanta</td></tr><tr><td style="text-align:center;">December 11, 2013</td></tr></table>';
	//$pdf->writeHTML($html, true, false, true, false, '');
	//$y = $this->getY();
	$this->writeHTMLCell(0, 0, 5, 14, $html, 0, 0, 0, true, 'J', true);
	
	$html='<p  style="font-weight: bold;text-align:center;">Proficiency Testing Program for Anti-HIV Antibodies Diagnostics using '.$this->scheme_name.'</p><hr/>';
	//$result['scheme_name']
	$this->writeHTMLCell(0, 0, 20, 30, $html, 0, 0, 0, true, 'J', true);
	
    }

    // Page footer
    public function Footer() {
        // Position at 15 mm from bottom
        $this->SetY(-15);
        // Set font
        $this->SetFont('helvetica', 'I', 8);
        // Page number
        $this->Cell(0, 10, 'Page '.$this->getAliasNumPage().'/'.$this->getAliasNbPages(), 0, false, 'C', 0, '', 0, false, 'T', 'M');
	
	
    }
}

foreach($this->result as $result){
	//error_log($i);
	// Extend the TCPDF class to create custom Header and Footer

	// create new PDF document
	$pdf = new MYPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
	
	$pdf->setSchemeName($result['scheme_name']);
	// set document information
	$pdf->SetCreator(PDF_CREATOR);
	$pdf->SetAuthor('Nicola Asuni');
	$pdf->SetTitle('DEPARTMENT OF HEALTH AND HUMAN SERVICES');
	//$pdf->SetSubject('TCPDF Tutorial');
	//$pdf->SetKeywords('TCPDF, PDF, example, test, guide');

	// set default header data
	$pdf->SetHeaderData(PDF_HEADER_LOGO, PDF_HEADER_LOGO_WIDTH, PDF_HEADER_TITLE, PDF_HEADER_STRING);
	
	// set header and footer fonts
	$pdf->setHeaderFont(Array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
	$pdf->setFooterFont(Array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));
	
	// set default monospaced font
	$pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);
	
	// set margins
	
	$pdf->SetMargins(PDF_MARGIN_LEFT, 50, PDF_MARGIN_RIGHT);
	$pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
	$pdf->SetFooterMargin(PDF_MARGIN_FOOTER);
	
	// set auto page breaks
	$pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);
	
	// set image scale factor
	$pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);
	
	// set some language-dependent strings (optional)
	if (@file_exists(dirname(__FILE__).'/lang/eng.php')) {
	    require_once(dirname(__FILE__).'/lang/eng.php');
	    $pdf->setLanguageArray($l);
	}

	// ---------------------------------------------------------
	
	// set font
	$pdf->SetFont('times', '', 12);
	
	// add a page
	$pdf->AddPage();
	
	// set some text to print
	//$txt = <<<EOD
	//International Laboratory Branch
	//
	//Custom page header and footer are defined by extending the TCPDF class and overriding the Header() and Footer() methods.
	//EOD;
	//
	//// print a block of text using Write()
	//$pdf->Write(0, $txt, '', 0, 'C', true, 0, false, false, 0);

	// ---------------------------------------------------------
	
	if(trim($result['shipment_date'])!=""){
		$result['shipment_date']=$this->dateFormat($result['shipment_date']);
	}
	if(trim($result['lastdate_response'])!=""){
		$result['lastdate_response']=$this->dateFormat($result['lastdate_response']);
	}
	
	$responseDate="";
	$shipmentScore="";
	$score="";

	if(trim($result['responseResult'][0]['responseDate'])!=""){
		$splitDate=explode(" ",$result['responseResult'][0]['responseDate']);
		$responseDate=$this->dateFormat($splitDate[0]);
	}
	if(trim($result['shipment_score'])!=""){
		$shipmentScore=$result['shipment_score'];
	}
	if(trim($result['max_score'])!=""){
		$score=100*round($shipmentScore/$result['max_score'],2);
	}
	
	if($score==100){
		$wishes='<p>Congratulations! You have received a satisfactory score of '.$score.'%.</p><br/>';
	}else{
		$wishes='<p>You have received a score of '.$score.'%.</p><br/>';
	}
	
	$labInfo='<table style="width:100%;"><tr><td style="font-weight:bold;">Participant Code </td><td style="text-align:left;width:20px;">:</td><td style="text-align:left;width:400px;">'.$result['unique_identifier'].'</td></tr>';
	$labInfo.='<tr><td  style="font-weight:bold;">Performing Participant </td><td style="text-align:left">:</td><td style="text-align:left">'.$result['first_name']." ".$result['last_name'].'</td></tr>';
	$labInfo.='<tr><td style="font-weight:bold;">PT Event Name </td><td style="text-align:left">:</td><td style="text-align:left">'.$result['distribution_code'].'</td></tr>';
	$labInfo.='<tr><td style="font-weight:bold;">Shipment Date </td><td style="text-align:left">:</td><td style="text-align:left">'.$result['shipment_date'].'</td></tr>';
	$labInfo.='<tr><td style="font-weight:bold;">Last Response Date </td><td style="text-align:left">:</td><td style="text-align:left">'.$result['lastdate_response'].'</td></tr>';
	$labInfo.='<tr><td style="font-weight:bold;">Response Date </td><td style="text-align:left">:</td><td style="text-align:left">'.$responseDate.'</td></tr>';
	
	$labInfo.='</table>';
	
	$pdf->writeHTML($labInfo, true, false, true, false, '');
	
	
	
	$html='<p style="font-weight: bold;">Your laboratory test results : <br/></p>';
	$pdf->writeHTML($html, true, false, true, false, '');
	if(sizeof($result['responseResult'])>0){
		if($schemeType != 'vl'){
			$labRes='<table border="1" style="text-align:center;font-weight:bold;width:400px;">
						<tr>
							<td style="background-color:#989898;">Specimen Panel ID </td>
							<td style="background-color:#989898;">Your Results</td>
							<td style="background-color:#989898;">Expected Results</td>
						</tr>';
			foreach($result['responseResult'] as $response){
				$labRes.='<tr>
							<td style="text-align:center;">'.$response['sample_label'].'</td>
							<td>'.$response['labResult'].'</td>
							<td>'.$response['referenceResult'].'</td>
						  </tr>';
			}
			$labRes.='</table>';
			$pdf->SetLeftMargin(40);
			$pdf->writeHTML($labRes, true, false, true, false, '');
		}else{
			$labRes='<h5>'.$result['responseResult'][0]['vl_assay'].'</h5>';
			$labRes.='<table border="1" style="text-align:center;font-weight:bold;width:650px;">
						<tr>
							<td style="background-color:#989898;">Specimen ID </td>
							<td style="background-color:#989898;">Your Results<br/>(log<sub>10</sub> copies/ml)</td>
							<td style="background-color:#989898;">Mean<br/>(log<sub>10</sub> copies/ml)</td>
							<td style="background-color:#989898;">S.D.</td>
							<td style="background-color:#989898;">Low</td>
							<td style="background-color:#989898;">High</td>
							<td style="background-color:#989898;">Your Grade</td>
						</tr>';
			foreach($result['responseResult'] as $response){
				$labRes.='<tr>
							<td style="text-align:center;">'.$response['sample_label'].'</td>
							<td>'.$response['reported_viral_load'].'</td>
							<td>'.$response['mean'].'</td>
							<td>'.$response['sd'].'</td>
							<td>'.$response['low'].'</td>
							<td>'.$response['high'].'</td>
							<td>'.$response['grade'].'</td>
						  </tr>';
			}
			$labRes.='</table>';
			$pdf->SetLeftMargin(15);
			$pdf->writeHTML($labRes, true, false, true, false, '');
		}

	}
	
	$pdf->SetLeftMargin(15);
	
	$pdf->writeHTML($wishes, true, false, true, false, '');
	
	//if(trim($result['distribution_date'])!=""){
	//	$result['distribution_date']=$this->dateFormat($result['distribution_date']);
	//}
	
	
	$html='<p>Thank you for participating in the HIV Serology '.strtoupper($result['scheme_type']).' Proficiency Testing Program.</p>';
	$pdf->writeHTML($html, true, false, true, false, '');
	
	if (ob_get_contents()) ob_end_clean();
	//Close and output PDF document
	if(isset($result['last_name']) && trim($result['last_name'])!=""){
		$result['last_name']="_".$result['last_name'];
	}
	
	if (!file_exists(UPLOAD_PATH . DIRECTORY_SEPARATOR . 'reports'. DIRECTORY_SEPARATOR.$result['shipment_code']) && !is_dir(UPLOAD_PATH . DIRECTORY_SEPARATOR .'reports'. DIRECTORY_SEPARATOR.$result['shipment_code'])) {
		mkdir(UPLOAD_PATH . DIRECTORY_SEPARATOR . 'reports'. DIRECTORY_SEPARATOR.$result['shipment_code']);
        }
	
	$fileName=$result['first_name'].$result['last_name']."-".$result['map_id'].".pdf";
	$fileName = preg_replace('/[^A-Za-z0-9.]/', '-', $fileName);
	$fileName = str_replace(" ", "-", $fileName);
	$filePath = UPLOAD_PATH . DIRECTORY_SEPARATOR . 'reports'. DIRECTORY_SEPARATOR .$result['shipment_code']. DIRECTORY_SEPARATOR .$fileName;
	$created=$pdf->Output($filePath, "F");
	
	//$pdf->Output($fileName, 'I');

}
//============================================================+
// END OF FILE
//============================================================+
echo "Reports generated and can be downloaded by Participants.";
}