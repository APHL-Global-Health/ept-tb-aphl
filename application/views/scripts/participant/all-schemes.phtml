<?php
$authNameSpace = new Zend_Session_Namespace('datamanagers');
$genderHelper = $this->getHelper('DateFormat');
$dtFormat=  $genderHelper->getDateFormat();
?>
<link rel="stylesheet" href="<?php echo $this->baseUrl('css/daterangepicker.css'); ?>" type="text/css" media="all">
<section class="content-header">
    <h1> All PT Schemes </h1>
</section>
<section class="content">
<div class="box">
                <div class="box-body">
					<table class="table">
						<tr>
							<td style="width:20%;">Quality Check Date</td>
							
							<td style="width:30%;">
								<input type="text" id="qcDate" name="qcDate"  class="form-control input-sm" readonly="readonly" style="background: #fff" placeholder ="Click here to pick a Date Range"/>
							</td>
							<td>
								<button class="btn btn-success btn-sm" onclick="schemeTable.fnDraw()"><span>Search</span></button>  <button class="btn btn-danger btn-sm" onclick="document.location.href = document.location"><span>Reset</span></button>
							</td>
						</tr>
					</table>
					<?php
					if($this->globalQcAccess=='yes' && (isset($authNameSpace->qc_access) && $authNameSpace->qc_access=='yes')){
					?>
						<input type="hidden" name="participantMapId" id="participantMapId"/>
						<div style="padding-top:20px;">
							<a href="javascript:void(0)" onclick="checkQcStatus()" class="btn btn-primary btn-sm" style="margin-bottom: 15px;"><i class="fa fa-cogs"></i>&nbsp;<b>(<span id="qcCount">0</span>) Selected for Quality Check</b></a>
						</div>
					<?php
					}
					?>
			<table cellpadding="0" cellspacing="0" border="0" class="display datatable table table-bordered table-hover table-striped " id="allSchemeTable">
				<thead>
				    <tr>
					<th></th>
					<th style="width:30px;">Year</th>
					<th style="width:100px;">Shipment<br/>Date</th>
					<th style="width:50px;">Scheme</th>
					<th style="width:100px;">Shipment Code</th>
					<th>Participant</th>
					<th style="width:100px;">Response<br/>Date</th>
					<th style="width:100px;">Action</th>
					<th>Report</th>
	    
				    </tr>
				</thead>
				<tbody>
				    <tr>
					<td colspan="8" class="dataTables_empty">Loading data from server</td>
				    </tr>
				</tbody>
			</table>
				</div>
			</div>
</section>

<div class="deleteAction dialog" id="migrateBox">
	<div style="padding:10px;">
        <span onClick="hidedefModal()" class="closeModal"></span>
        <h3>Quality Check Done</h3>
        <table  class="display datatable table table-bordered table-hover table-striped ">
			<tr>
				<th>QC Done on : </th>
				<td><input type="text" id="qcDate" name="qcDate"  style="width:180px;float:left;"  maxlength="11" value=""  class="isRequired form-control" readonly="readonly" /></td>
			</tr>
		</table>
		
		<div class="box-footer" style="text-align: center">
			<button class="btn btn-primary" onclick="submitQcForm();return false;">Submit</button>
		</div>
    </div>
</div>
<script type="text/javascript" src="<?php echo $this->baseUrl('js/daterangepicker.js'); ?>"></script>
<script>
    var schemeTable = null;
	var selectedQc=[];
	function allSchemes(){
		schemeTable = $('#allSchemeTable').dataTable({
			"oLanguage": {
			    "sLengthMenu": "_MENU_ records per page"
			},
			"bJQueryUI": false,
			"bAutoWidth": false,
			"bInfo": true,
			"bScrollCollapse": true,
			"sPaginationType": "full_numbers",
			"bRetrieve": true,                        
			"aoColumns": [
				{"bSortable":false},
			    {"sClass":"center"},
			    {"sClass":"center"},
			    {"sClass":"center"},
			    {"sClass":"center"},
			    {"sClass":""},
			    {"sClass":"center"},
			    {"sClass":"center","bSortable":false},
			    {"sClass":"center","bSortable":false}
			],
			"aaSorting": [[ 1, "desc" ]],
			"fnDrawCallback": function() {
                var checkBoxes=document.getElementsByName("subchk[]");
                len = checkBoxes.length;
                for(c=0;c<len;c++){
                    if (jQuery.inArray(checkBoxes[c].id,selectedQc) != -1 )
                    {
                        checkBoxes[c].setAttribute("checked",true);
                    }
                }
                
            },
			"bProcessing": true,
			"bServerSide": true,
			"sAjaxSource": "<?php echo $this->url(array('module' => 'default', 'controller' => 'participant', 'action' => 'all-schemes', 'format' => 'html')); ?>",
			"fnServerParams": function (aoData) {
                aoData.push({"name": "qcDate", "value": $("#qcDate").val()});
            },
			"fnServerData": function ( sSource, aoData, fnCallback ) {
			    $.ajax({
				"dataType": 'json',
				"type": "POST",
				"url": sSource,
				"data": aoData,
				"success": fnCallback
			    });
			}
		});
	}
	
	
	$(document).ready(function(){
		allSchemes();
		$('#qcDate').daterangepicker({
            format: 'DD-MMM-YYYY',
            ranges: {
			'Last 60 Days': [moment().subtract('days', 59), moment()],
			'Last 90 Days': [moment().subtract('days', 89), moment()],
			'Last 180 Days': [moment().subtract('days', 179), moment()],
			'Last 12 Months': [moment().subtract('month', 12), moment()],
			'Last 18 Months': [moment().subtract('month', 18), moment()],
            }
        },
        function(start, end) {
                    startDate = start.format('YYYY-MM-DD');
                    endDate = end.format('YYYY-MM-DD');
        });
	});
    
    
	
    function removeSchemes(schemeType,mid){
		if (window.confirm("Are you sure you want to remove this response?\n This cannot be undone !")) { 
			$.blockUI();
			$.post("<?php echo $this->url(array('module'=>'default','controller' =>'Dts', 'action' => 'delete')); ?>", { mid: mid, format: "html" },
			    function (data) {
				alert("Response removed successfully");
				schemeTable.fnDraw();
				$.unblockUI();
			});
		}		
		
	}
	
	function addQc(mapId,obj){
		if(obj.checked==true)
        {
			if($.inArray(mapId,selectedQc) == -1){
			selectedQc.push(mapId);
			}
		}else{
			selectedQc.remove(mapId);
		}
		$("#participantMapId").val(selectedQc);
		$("#qcCount").text(selectedQc.length);
        
    }
	function addSingleQc(mapId,qcDate) {
		//$("#qcDate").val(qcDate);
        if($.inArray(mapId,selectedQc) == -1){
			selectedQc.push(mapId);
			$("#participantMapId").val(selectedQc);
		}
		showQcForm();
    }
	function showQcForm() {
        showdefModal("migrateBox", 600,400);
		$("#qcDate").datepicker({dateFormat: '<?php echo $dtFormat; ?>'});
    }
	
	function submitQcForm() {
		participantMapId=$("#participantMapId").val();
		qcDate=$("#qcDate").val();
		if (participantMapId!="" && qcDate!="") {
            $.post("<?php echo $this->url(array('module'=>'default','controller' =>'participant', 'action' => 'add-qc')); ?>", { mapId: participantMapId,qcDate:qcDate,format: "html" },
			function(data){
			if(data>0)
			{
				schemeTable.fnDraw();
				$("#countChecksPending").text("0");
				selectedQc = '';
				alert("Qc details added successfully");
				hidedefModal();
			}
			});
			
        }else{
			alert("Please select the date");
		}
        
    }
	
	function checkQcStatus() {
        if(selectedQc.length==0){
			alert("Please select any one shipment");
		}else{
			showQcForm();
		}
    }
</script>