<?php date_default_timezone_set('America/New_York'); ?>
<form name="eidResponseForm" id="eidResponseForm" method="post"   action="<?php echo $this->url(array("controller" => "eid", "action" => "response"), null, true) ?>">

    <input type="hidden" id ="hdLastDate" name="hdLastDate" value="<?php echo $this->shipment['lastdate_response']; ?>" />
    <input type="hidden" id ="shipmentId" name="shipmentId" value="<?php echo $this->shipId; ?>" />


    <input type="hidden" id ="participantId" name="participantId" value="<?php echo $this->participantId; ?>" />
    <input type="hidden" id ="smid" name="smid" value="<?php echo $this->shipment['map_id']; ?>" />
    <input type="hidden" id ="evId" name="evId" value="<?php echo $this->eID; ?>" />


    <div id="view-content">
        <h2 align="CENTER"> Early Infant Diagnosis </h2>
        <br>
        <div id=error></div>
        <table>
            <tr>
                <td> <span class="txt"> Participant Name </span> <?php echo ( $this->participant['first_name'] . ' ' . $this->participant['last_name'] ); ?></td>
                <td><span class="txt"> Participant Code </span> <?php echo $this->participant['unique_identifier'] ?></td>
                <td><span class="txt"> Affiliation </span> <?php echo ( $this->participant['affiliation'] ); ?> </td>
                <td><span class="txt"> Phone No </span> <?php echo ( $this->participant['mobile'] . '<br/>' . $this->participant['phone'] ); ?></td>
            </tr>
        </table>

        <table>
            <tr class="dark">
                <td>Shipment Date</td>
                <td><?php echo $this->dateFormat($this->shipment['shipment_date']); ?></td>
                <td>Result Due Date <?php ?></td>
                <td><?php echo $this->dateFormat($this->shipment['lastdate_response']); ?> </td>
            </tr>
            <tr class ="light">
                <td>Shipment Receipt Date</td>
                <td><input type="text" id="receiptDate" name="receiptDate" size="11" maxlength="11" value="<?php echo $this->dateFormat($this->shipment["shipment_receipt_date"]); ?>"  class="datepicker isRequired" readonly="readonly"/></td>
                <td>Testing Date</td> 
                <td><input type="text" id="testDate" name="testDate" size="11" maxlength="11" value="<?php echo $this->dateFormat($this->shipment["shipment_test_date"]); ?>"   class="datepicker isRequired" readonly="readonly"/></td>
            </tr>

            <tr class ="dark">
                <td>Extraction Assay:</td>
                <td>
                    <select id="extractionAssay" name="extractionAssay">
                        <option value="">--Select--</option>
                        <?php
                        foreach ($this->extractionAssay as $eAssay) {
                            ?>
                            <option value="<?php echo $eAssay['id']; ?>" <?php echo (isset($this->shipment['attributes']['extraction_assay']) && $this->shipment['attributes']['extraction_assay'] == $eAssay['id']) ? "selected='selected'" : "" ?>><?php echo $eAssay['name']; ?></option>	
                            <?php
                        }
                        ?>
                    </select>
                </td>
                <td>Detection Assay:</td> 
                <td>
                    <select id="detectionAssay" name="detectionAssay">
                        <option value="">--Select--</option>
                        <?php
                        foreach ($this->detectionAssay as $dAssay) {
                            ?>
                            <option value="<?php echo $dAssay['id']; ?>" <?php echo (isset($this->shipment['attributes']['detection_assay']) && $this->shipment['attributes']['detection_assay'] == $dAssay['id']) ? "selected='selected'" : "" ?>><?php echo $dAssay['name']; ?></option>	
                            <?php
                        }
                        ?>				
                    </select>
                </td>
            </tr>
            <tr>
                <td>Sample Rehydration Date</td>
                <td><input type="text" name="sampleRehydrationDate" id="sampleRehydrationDate" class="datepicker" readonly="readonly" value="<?php echo $this->dateFormat($this->shipment['attributes']["sample_rehydration_date"]); ?>"  /></td>
                <td></td>
                <td></td>
            </tr>
        </table>

        <?php
        $possibleResults = array();
        foreach ($this->eidPossibleResults as $pr) {
            if ($pr['scheme_sub_group'] == 'EID_FINAL') {
                $possibleResults[$pr['id']] = $pr['response'];
            }
        }
        ?>

        <table style="width: max-content;" border="1">
            <thead>
                <tr align="CENTER" class="dark" >
                    <th style="width:25%;">Control/Sample</th>
                    <th>Your Results</th>
                    <th>HIV CT/OD</th>
                    <th>IC/QS Values</th>		
                </tr>
            </thead>

            <?php
            $count = 0;
            foreach ($this->allSamples as $sample) {
                $count++;
                ?>


                <tr align="CENTER" class="light" >
                    <th style="white-space: nowrap">
                        <?php echo $sample['sample_label']; ?> <?php echo ($sample['mandatory'] == 1) ? " <span class='mandatory'>*</span>" : "&nbsp;&nbsp;"; ?>
                        <input type="hidden" id ="sample<?php echo $count; ?>" name="sampleId[]" value="<?php echo $sample['sample_id']; ?>" />
                    </th>
                    <td class="dark" >

                        <select name="result[]" id="result<?php echo $count; ?>"  style="width: 200px"   <?php echo ($sample['mandatory'] == 1) ? "class='isRequired'" : ""; ?> title="Please select the result for <?php echo $sample['sample_label']; ?>">
                            <?php $this->dropdownSelection($possibleResults, $sample['reported_result'], true); ?>
                        </select>
                    </td>
                    <td>
                        <input type="text" name="hivCtOd[]" <?php echo ($sample['mandatory'] == 1) ? "class='isRequired'" : ""; ?>value="<?php echo $sample['hiv_ct_od']; ?>" title="Please enter the HIV CT/OD for <?php echo $sample['sample_label']; ?>" />
                    </td>
                    <td>
                        <input type="text" name="icQs[]" <?php echo ($sample['mandatory'] == 1) ? "class='isRequired'" : ""; ?>value="<?php echo $sample['ic_qs']; ?>" title="Please enter the IC/QS Values for <?php echo $sample['sample_label']; ?>" />
                    </td>
                </tr>


            <?php } ?>


        </table>
        <br>
        <table>
            <tr>
                <th>Supervisor Review</th>
                <td>
                    <select name="supervisorApproval" id="supervisorApproval" class="isRequired" title="Please select if Supervisor Approval was conducted or not">
                        <option value="">--Select--</option>
                        <option value="yes" <?php if ($this->shipment['supervisor_approval'] == 'yes') echo " selected "; ?>>YES</option>
                        <option value="no" <?php if ($this->shipment['supervisor_approval'] == 'no') echo " selected "; ?>>NO</option>
                    </select>
                </td>
                <th><label id ="labSupervisor" <?php echo(isset($this->shipment['supervisor_approval']) && $this->shipment['supervisor_approval'] == 'yes') ? "" : "style='display:none;'" ?> >Supervisor Name</label></th> 
                <td><input name="participantSupervisor" id="participantSupervisor" type="text" <?php echo(isset($this->shipment['supervisor_approval']) && $this->shipment['supervisor_approval'] == 'yes') ? "" : "style='display:none;'" ?>  value="<?php echo $this->shipment['participant_supervisor']; ?>"/></td>

            </tr>
            <tr>

                <th>Comments </th>
                <td colspan="3">
                    <textarea name="userComments" id="userComments" size="120" maxlength="40"><?php echo $this->shipment['user_comment']; ?></textarea>

                </td>
            </tr>

        </table>
        <?php if ($this->isEditable) { ?>
            <div id="respond" style="margin: 0px auto 0px auto; text-align: center;">
                <p>

                    <input name="submitbtn" class="css_btn_class" type="button" onclick="validateNow();
                                                    return false;" tabindex="7" value="Submit"  /> 
                    &nbsp;&nbsp;&nbsp;
                    <input name="cancel" class="css_btn_class" type="button" id="reset" tabindex="8" value="Cancel" onclick="javascript:goto_dashboard()" /> 

                </p>
            </div>
        <?php } ?>
    </div>
</form>
<?php if (!$this->isEditable) {
    ?>
    <div id="respond" style="margin: 0px auto 0px auto; text-align: center;">
        <input name="cancel" class="css_btn_class" type="button" id="reset" tabindex="8" value="Back" onclick="javascript:goto_dashboard()" />
    </div>
    <?php
}
?>

<script>

    function goto_dashboard() {
        window.history.back();
    }

    function validateNow() {

        flag = deforayValidator.init({
            formId: 'eidResponseForm'
        });
        if (flag) {
            if (moment($("#receiptDate").val(), "DD-MMM-YYYY").isAfter($("#testDate").val(), "DD-MMM-YYYY")) {
                alert('Testing Date has to come after the Shipment Receipt Date');
                return false;
            }
            $.blockUI();
            document.getElementById('eidResponseForm').submit();
        }

    }


    $(function () {
        $(".datepicker").datepicker({dateFormat: '<?php echo $this->defaultDateFormat(); ?>', maxDate: '0', minDate: new Date('<?php echo $this->shipment['shipment_date']; ?>')});
        $(".expDatepicker").datepicker({dateFormat: '<?php echo $this->defaultDateFormat(); ?>'});
<?php if (!$this->isEditable) {
    ?>
            $("#eidResponseForm").find("input:enabled, select:enabled, textarea:enabled").attr("disabled", "disabled");
    <?php
}
?>
    });


    $('#supervisorApproval').change(function () {

        if ($('#supervisorApproval').val() == 'yes')
        {
            $('#labSupervisor').show();
            $('#participantSupervisor').val('');
            $('#participantSupervisor').show();
        }
        else {
            $('#labSupervisor').hide();
            $('#participantSupervisor').val('');
            $('#participantSupervisor').hide();
        }
    });
</script>