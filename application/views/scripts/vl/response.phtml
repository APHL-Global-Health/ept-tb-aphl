<?php date_default_timezone_set('America/New_York');?>
<form name="vlResponseForm" id="vlResponseForm" method="post"   action="<?php echo $this->url(array("controller"=>"vl","action"=>"response"),null,true) ?>">

<input type="hidden" id ="hdLastDate" name="hdLastDate" value="<?php echo $this->shipment['lastdate_response'];?>" />
<input type="hidden" id ="smid" name="smid" value="<?php echo $this->shipment['map_id'];?>" />
<input type="hidden" id ="hdshipId" name="hdshipId" value="<?php echo $this->shipId;?>" />


<input type="hidden" id ="hdparticipantId" name="hdparticipantId" value="<?php echo $this->participantId;?>" />
<input type="hidden" id ="hdeID" name="hdeID" value="<?php echo $this->eID;?>" />
<?php $count =0;  
foreach($this->allSamples as $sample){ 
$count++;  ?>
<input type="hidden" id ="<?php echo $count . "_hdSampleId"; ?>" name="<?php echo $count . "_hdSampleId"; ?>" value="<?php echo $sample['sample_id'];?>" />	 
<?php } ?>

<?php 
//  $dt= DateTime::createFromFormat('Y-m-d',$this->shipment["ShipmentReceiptDate"]); echo $dt->format('d-M-Y'); 


?>
<div id="view-content">
<h2 align="CENTER"> Viral Load </h2>
<br>
<div id=error></div>
<table>
<tr>
	<td> <span class="txt"> Participant </span> <?php echo ( $this->participant['first_name'] . ' ' . $this->participant['last_name'] );?></td>
	<td><span class="txt"> Affiliation </span> <?php echo ( $this->participant['affiliation'] );?> </td>
	<td><span class="txt"> Phone No </span> <?php  echo ( $this->participant['mobile']  . '  ' .   $this->participant['phone'] ); ?></td>
</tr>
</table>

<table>
	<tr class="dark">
		<td>Shipment Date</td>
		<td><?php echo $this->dateFormat($this->shipment['shipment_date']);?></td>
		<td>Last Response Date <?php  ?></td>
		<td><?php echo $this->dateFormat($this->shipment['lastdate_response']);?> </td>
	</tr>
	
	
	
	<tr class ="light">
		<td>Shipment Receipt Date</td>
		<td><input type="text" id="receiptDate" name="receiptDate" maxlength="11" value="<?php  echo $this->dateFormat($this->shipment["shipment_receipt_date"]);  ?>"  class="isRequired datepicker" readonly="readonly" /></td>
		<td>Testing Date</td> 
		<td><input type="text" id="testDate" name="testDate" maxlength="11" value="<?php  echo  $this->dateFormat($this->shipment["shipment_test_date"]); ?>"  class="isRequired datepicker" readonly="readonly" /></td>
	</tr>
	<tr>
		<td>Sample Rehydration Date</td>
		<td><input type="text" name="sampleRehydrationDate" id="sampleRehydrationDate"value="<?php  echo  $this->dateFormat($this->shipment['attributes']["sample_rehydration_date"]); ?>" class="isRequired datepicker" readonly="readonly" /></td>
		<td></td>
		<td></td>
	</tr>
	
	<tr class ="dark">
		<td>Viral Load Assay:</td>
		<td>
			<select id="vlAssay" name="vlAssay">
			<option>--Select--</option>
			<?php
			foreach($this->vlAssay as $vlAssay){
				?>
				<option value="<?php echo $vlAssay['id']; ?>"  <?php echo ($this->shipment['attributes']['vl_assay'] == $vlAssay['id']) ? "selected='selected'" : "";?>><?php echo $vlAssay['name']; ?></option>	
				<?php
			}
			?>
		</select>
		</td>
		<td>Assay Lot Number:</td> 
		<td>
			<input type="text" name="assayLotNumber" id="assayLotNumber" class="isRequired"  value="<?php echo $this->shipment['attributes']['assay_lot_number'];?>"/>
		</td>
	</tr>

	<tr class ="dark">
		<td>Assay Expiration Date:</td>
		<td>
			<input type="text" name="assayExpirationDate" id="assayExpirationDate" class="isRequired datepicker" readonly="readonly"  value="<?php echo $this->dateFormat($this->shipment['attributes']['assay_expiration_date']);?>"/>
		</td>
		<td>Specimen Volume:</td> 
		<td>
			<input type="text" name="specimenVolume" id="specimenVolume" class="isRequired"  value="<?php echo $this->shipment['attributes']['specimen_volume'];?>"/>
		</td>
	</tr>
	
</table>

<table style="width: max-content;" border="1">
<thead>
	<tr align="CENTER" class="dark" >
		<th style="width:35%;">Control/Sample</th>
		<th>Viral Load (log<sub>10</sub> copies/ml)</th>		
	</tr>
</thead>

<?php $count =0;  
foreach($this->allSamples as $sample){ 
$count++;
?>


	<tr align="CENTER" class="light" >
		<th>
			<?php echo $sample['sample_label']; ?>
			<input type="hidden" id ="sample<?php echo $count; ?>" name="sampleId[]" value="<?php echo $sample['sample_id'];?>" />
		</th>
        <td>
			<input type="text" name="vlResult[]" class="isRequired"  value="<?php echo $sample['reported_viral_load']; ?>" title="Please enter the Viral Load Values for <?php echo $sample['sample_label']; ?>" />
		</td>
    </tr>


<?php } ?>

</table>
<br>
<table>
<tr>
	<th>Supervisor Review</th>
	<td>
		<select name="supervisorApproval" id="supervisorApproval" class="isRequired">
			<option>--Select--</option>
			<option value="YES" <?php if($this->shipment['supervisor_approval'] == 'YES') echo " selected "; ?>>YES</option>
			<option value="NO" <?php if($this->shipment['supervisor_approval'] == 'NO') echo " selected "; ?>>NO</option>
		</select>
	</td>
	<th><label id ="labSupervisor"  <?php echo(isset($this->shipment['supervisor_approval']) && $this->shipment['supervisor_approval'] == 'YES') ? "" : "style='display:none;'" ?> >Supervisor Name</label></th> 
	<td><input name="participantSupervisor" id="participantSupervisor" <?php echo(isset($this->shipment['supervisor_approval']) && $this->shipment['supervisor_approval'] == 'YES') ? "" : "style='display:none;'" ?>  type="text"size="10" maxlength="10" value="<?php echo $this->shipment['participant_supervisor'] ; ?>"/></td>
	
</tr>
<tr>

<th>Comments </th>
<td colspan="3">
<textarea name="userComments" id="userComments" size="120" maxlength="40"><?php echo $this->shipment['user_comment'] ; ?></textarea>

</td>
</tr>

</table>

	<div id="respond" style="margin: 0px auto 0px auto; text-align: center;">
				<p>
					
					<input name="submitbtn" class="css_btn_class" type="submit" onclick="validateNow();return false;" tabindex="7" value="Submit"  /> 
					&nbsp;&nbsp;&nbsp;
					<input name="cancel" class="css_btn_class" type="button" id="reset" tabindex="8" value="Cancel" onclick="javascript:goto_dashboard()" /> 
					
				</p>
			</div>
</div>
<?php 
$genderHelper = $this->getHelper('DateFormat');
$dtFormat=  $genderHelper->getDateFormat();
?>
</form>
 <style type="text/css">
textarea:focus { outline: 1px solid blue; }




</style>

 
<script>
	
	function goto_dashboard(){
		window.history.back();
	}

	$(function() {
  	    $(".datepicker" ).datepicker({dateFormat: '<?php echo $dtFormat;?>'});
	});
	
	
	function validateNow(){

		flag = deforayValidator.init({
			formId: 'vlResponseForm'
		});
		if(flag){
			if(moment($("#receipt_date").val(), "DD-MMM-YYYY").isAfter($("#test_date").val(), "DD-MMM-YYYY")){
				alert('Testing Date has to come after the Shipment Receipt Date');
				return false;
			}				
			$.blockUI();
			document.getElementById('vlResponseForm').submit();
		}
	}	
	$('#supervisorApproval').change(function() {		
		if ($('#supervisorApproval').val() =='YES') 
		{
			$('#labSupervisor').show();
			$('#participantSupervisor').val('');
			$('#participantSupervisor').show();
		  }
		else{
			$('#labSupervisor').hide();
			$('#participantSupervisor').val('');
			$('#participantSupervisor').hide();
		}
	});
  </script>